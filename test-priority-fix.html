<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment Priority Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .assignment { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 8px; }
        .assignment-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .priority-input { width: 60px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; }
        .button { background: none; border: none; color: #6b7280; cursor: pointer; font-size: 14px; padding: 2px; }
        .remove-button { color: #dc2626; font-size: 16px; }
        .log { background: #f5f5f5; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Assignment Priority Test</h1>
    
    <div class="test-section">
        <h2>Test Assignment Priority Updates</h2>
        <p>This test simulates the assignment priority functionality to verify that priorities are preserved correctly.</p>
        
        <div id="assignments-list">
            <!-- Assignments will be displayed here -->
        </div>
        
        <button onclick="addTestAssignment()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Add Test Assignment</button>
        <button onclick="normalizePriorities()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px;">Normalize Priorities</button>
        <button onclick="saveAssignments()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px;">Save Assignments</button>
    </div>
    
    <div class="test-section">
        <h2>Debug Log</h2>
        <div id="debug-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>Current Assignments Data</h2>
        <pre id="assignments-data" class="log"></pre>
    </div>

    <script>
        // Simulate the currentAssignments array
        let currentAssignments = [
            {
                id: '166',
                assignment_type: 'page',
                target_id: '10',
                target_value: 'Promo bar test x',
                priority: 1
            }
        ];

        function log(message) {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateAssignmentsData() {
            const dataDiv = document.getElementById('assignments-data');
            dataDiv.textContent = JSON.stringify(currentAssignments, null, 2);
        }

        function updateAssignmentsList() {
            const assignmentsList = document.getElementById('assignments-list');
            
            if (currentAssignments.length === 0) {
                assignmentsList.innerHTML = '<div style="text-align: center; color: #6b7280; font-size: 14px;">No assignments yet</div>';
                return;
            }
            
            // Sort assignments by priority
            const sortedAssignments = [...currentAssignments].sort((a, b) => (a.priority || 0) - (b.priority || 0));
            
            assignmentsList.innerHTML = sortedAssignments.map((assignment, index) => {
                const label = getAssignmentLabel(assignment);
                return `
                    <div class="assignment">
                        <div class="assignment-info">
                            <span style="font-size: 12px; color: #6b7280; min-width: 20px;">${assignment.priority || index + 1}</span>
                            <span style="font-size: 14px; color: #374151; flex: 1;">${label}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input 
                                type="number" 
                                value="${assignment.priority || index + 1}" 
                                min="1" 
                                max="999"
                                class="priority-input"
                                onchange="updateAssignmentPriority('${assignment.id}', this.value)"
                                title="Priority (lower number = higher priority)"
                            />
                            <button 
                                onclick="moveAssignmentUp('${assignment.id}')" 
                                class="button"
                                title="Move up"
                                ${index === 0 ? 'disabled' : ''}
                            >↑</button>
                            <button 
                                onclick="moveAssignmentDown('${assignment.id}')" 
                                class="button"
                                title="Move down"
                                ${index === sortedAssignments.length - 1 ? 'disabled' : ''}
                            >↓</button>
                            <button 
                                onclick="removeAssignment('${assignment.id}')" 
                                class="button remove-button"
                                title="Remove assignment"
                            >×</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateAssignmentsData();
        }

        function getAssignmentLabel(assignment) {
            switch (assignment.assignment_type) {
                case 'global':
                    return '🌐 All Pages';
                case 'page':
                    return `📄 Page: ${assignment.target_value}`;
                case 'post_type':
                    return `📝 All ${assignment.target_value}s`;
                case 'category':
                    return `🏷️ Category: ${assignment.target_value}`;
                case 'tag':
                    return `🏷️ Tag: ${assignment.target_value}`;
                case 'custom':
                    return `🔗 Custom: ${assignment.target_value}`;
                default:
                    return 'Unknown Assignment';
            }
        }

        function updateAssignmentPriority(assignmentId, newPriority) {
            log(`Updating priority for assignment: ${assignmentId} to: ${newPriority}`);
            log(`Current assignments before update: ${JSON.stringify(currentAssignments.map(a => ({ id: a.id, priority: a.priority })))}`);
            
            const assignment = currentAssignments.find(a => a.id === assignmentId);
            if (!assignment) {
                log(`ERROR: Assignment not found: ${assignmentId}`);
                return;
            }
            
            const priority = parseInt(newPriority) || 1;
            assignment.priority = Math.max(1, Math.min(999, priority));
            
            log(`Updated assignment priority: ${JSON.stringify(assignment)}`);
            log(`Current assignments after update: ${JSON.stringify(currentAssignments.map(a => ({ id: a.id, priority: a.priority })))}`);
            updateAssignmentsList();
        }

        function moveAssignmentUp(assignmentId) {
            log(`Moving assignment up: ${assignmentId}`);
            
            const assignment = currentAssignments.find(a => a.id === assignmentId);
            if (!assignment) {
                log(`ERROR: Assignment not found: ${assignmentId}`);
                return;
            }
            
            const sortedAssignments = [...currentAssignments].sort((a, b) => (a.priority || 0) - (b.priority || 0));
            const currentIndex = sortedAssignments.findIndex(a => a.id === assignmentId);
            
            if (currentIndex <= 0) {
                log('Assignment is already at the top');
                return;
            }
            
            const previousAssignment = sortedAssignments[currentIndex - 1];
            
            // Swap priorities
            const tempPriority = assignment.priority;
            assignment.priority = previousAssignment.priority;
            previousAssignment.priority = tempPriority;
            
            log(`Swapped priorities: ${assignment.priority}, ${previousAssignment.priority}`);
            updateAssignmentsList();
        }

        function moveAssignmentDown(assignmentId) {
            log(`Moving assignment down: ${assignmentId}`);
            
            const assignment = currentAssignments.find(a => a.id === assignmentId);
            if (!assignment) {
                log(`ERROR: Assignment not found: ${assignmentId}`);
                return;
            }
            
            const sortedAssignments = [...currentAssignments].sort((a, b) => (a.priority || 0) - (b.priority || 0));
            const currentIndex = sortedAssignments.findIndex(a => a.id === assignmentId);
            
            if (currentIndex >= sortedAssignments.length - 1) {
                log('Assignment is already at the bottom');
                return;
            }
            
            const nextAssignment = sortedAssignments[currentIndex + 1];
            
            // Swap priorities
            const tempPriority = assignment.priority;
            assignment.priority = nextAssignment.priority;
            nextAssignment.priority = tempPriority;
            
            log(`Swapped priorities: ${assignment.priority}, ${nextAssignment.priority}`);
            updateAssignmentsList();
        }

        function removeAssignment(id) {
            log(`Removing assignment with ID: ${id}`);
            log(`Current assignments before removal: ${JSON.stringify(currentAssignments.map(a => ({ id: a.id, priority: a.priority })))}`);
            
            const beforeCount = currentAssignments.length;
            currentAssignments = currentAssignments.filter(a => a.id !== id);
            const afterCount = currentAssignments.length;
            
            log(`Removed ${beforeCount - afterCount} assignments`);
            log(`Current assignments after removal: ${JSON.stringify(currentAssignments.map(a => ({ id: a.id, priority: a.priority })))}`);
            
            // Update the display after removal (don't normalize priorities automatically)
            updateAssignmentsList();
        }

        function normalizePriorities() {
            log('Normalizing priorities...');
            
            const sortedAssignments = [...currentAssignments].sort((a, b) => (a.priority || 0) - (b.priority || 0));
            
            sortedAssignments.forEach((assignment, index) => {
                assignment.priority = index + 1;
            });
            
            log(`Normalized priorities: ${JSON.stringify(sortedAssignments.map(a => ({ id: a.id, priority: a.priority })))}`);
            updateAssignmentsList();
        }

        function addTestAssignment() {
            const newId = `test_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const newAssignment = {
                id: newId,
                assignment_type: 'category',
                target_id: Math.floor(Math.random() * 100),
                target_value: `Test Category ${currentAssignments.length + 1}`,
                priority: currentAssignments.length + 1
            };
            
            currentAssignments.push(newAssignment);
            log(`Added new test assignment: ${JSON.stringify(newAssignment)}`);
            updateAssignmentsList();
        }

        function saveAssignments() {
            log('=== SAVING ASSIGNMENTS ===');
            log(`Assignments to save: ${JSON.stringify(currentAssignments.map(a => ({ id: a.id, priority: a.priority })))}`);
            
            // Simulate the save process (without normalization)
            const dataToSave = {
                assignments: JSON.stringify(currentAssignments)
            };
            
            log(`Data to save: ${JSON.stringify(dataToSave)}`);
            log('=== SAVE COMPLETE ===');
        }

        // Initialize the display
        updateAssignmentsList();
        log('Test initialized with sample assignment');
    </script>
</body>
</html>
